{% extends "base.html" %}
{% load widget_tweaks %}
{% load spotify_extras %}

{% block content %}
<div class="max-w-2xl mx-auto bg-[#f5f0fb] p-6 rounded-2xl shadow-lg">
  <!-- Content -->
  <h2 class="text-2xl font-bold mb-4 text-[#6c5ecf]">{{ entry.title }}</h2>
  <p class="mb-4 whitespace-pre-wrap text-[#5e4b3c]">{{ entry.content }}</p>

  <!-- Is a song was Shared -->
  {% if entry.song_url %}
    <div class="mt-6">
      <p class="text-sm text-[#bfa7f2] mb-1 font-medium">
        üéµ {{ entry.song_title }}
      </p>

      <!-- Embedded Player for Journal -->
      <iframe style="border-radius:12px"
        src="https://open.spotify.com/embed/track/{{ entry.song_url|extract_track_id }}?utm_source=generator&theme=1"
        width="100%" height="80" frameBorder="0" allowfullscreen
        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
        lading="lazy">
      </iframe>

      <!-- Lyric Snippet -->
      {% if entry.lyric_snippet %}
        <p class="mt-4 text-sm italic text-[#5e4b3c] text-center">
          ‚Äú{{ entry.lyric_snippet|linebreaksbr }}‚Äù
        </p>
      {% endif %}

    </div>
  {% endif %}

  <hr class="my-6 border-[#e0d4f7]">

  <!-- Comment List -->
  <h3 class="text-xl font-semibold mb-3 text-[#bfa7f2]">Comments</h3>
  {% for comment in comments %}
    <div class="mb-4 border border-[#dacbed] rounded-lg p-3 bg-[#f9f7fb]">
      <!-- Comment Writer -->
      <p class="text-sm font-semibold text-[#bfa7f2] mb-1">
        @{{ comment.author.username }}
      </p>

      <!-- Comment Content -->
      <p class="text-sm text-[#5e4b3c] whitespace-normal mb-1">
        {{ comment.content|linebreaksbr }}
      </p>

      <!-- Embedded Player for Comment -->
      {% if comment.song_url %}
        <div class="mt-2">
          <p class="text-sm text-[#bfa7f2] mb-1 font-medium">
            üéµ <a href="{{ comment.song_url }}" target="_blank" rel="noopener noreferrer" class="underline hover:text-[#a88fe8]">
              {{ comment.song_title }}
            </a>
          </p>
        </div>
      {% endif %}

      

      <!-- Created At -->
      <p class="text-xs text-[#6c5ecf]">
        {{ comment.created_at|date:"M d, Y H:i" }}
      </p>
    </div>
  {% empty %}
    <p class="text-[#5e4b3c]">No comments yet.</p>
  {% endfor %}

  <hr class="my-6 border-[#e0d4f7]">

  <!-- ÎåìÍ∏Ä Ìèº -->
  {% if user.is_authenticated %}
  <form method="post" class="space-y-4">
    {% csrf_token %}

    <div>
      <label for="id_content" class="block text-sm font-semibold text-[#726a60] mb-1">Leave a comment</label>
      {% render_field form.content rows="3" class="w-full rounded-xl border-gray-300 shadow-sm focus:outline-none focus:ring focus:ring-[#cdb4db]" %}
    </div>

    {% render_field form.song_title type="hidden" %}
    {% render_field form.song_url type="hidden" %}


    <!-- ÏùåÏïÖ Ï∂îÏ≤ú ÌÜ†Í∏Ä -->
    <button type="button" id="toggle-music" class="text-sm text-[#bfa7f2] hover:text-[#a88fe8] hover:underline">
      üéµ Share Music
    </button>

    <!-- ÏùåÏïÖ Í≤ÄÏÉâ Î∞ïÏä§ -->
    <div id="music-search-box" class="mt-2 hidden">
      <input type="text" id="music-search-input"
             class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
             placeholder="Search by song title or artist">
      <div id="music-results" class="mt-2 space-y-1 text-sm"></div>
    </div>

    <div>
      <button type="submit" class="bg-[#6c5ecf] hover:bg-[#5948b3] text-white px-5 py-2 rounded-full font-semibold shadow transition">
        Submit Comment
      </button>
    </div>
  </form>
  {% else %}
    <p class="text-sm text-gray-500">You must be logged in to comment.</p>
  {% endif %}

  <!-- ÎåìÍ∏Ä Ìèº Î¶¨ÏÖã Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script>
    window.addEventListener("pageshow", function(event) {
      if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
        const textarea = document.querySelector("#id_content");
        if (textarea) {
          textarea.value = "";
        }
      }
    });
  </script>
</div>
{% endblock %}

{% block ajax_logic %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggleButton = document.getElementById("toggle-music");
  const searchBox = document.getElementById("music-search-box");
  const searchInput = document.getElementById("music-search-input");
  const resultsBox = document.getElementById("music-results");

  const songTitleField = document.getElementById("id_song_title");
  const songUrlField = document.getElementById("id_song_url");

  toggleButton.addEventListener("click", function () {
    searchBox.classList.toggle("hidden");
    resultsBox.innerHTML = "";
    searchInput.value = "";
  });

  searchInput.addEventListener("input", function () {
    const query = searchInput.value.trim();
    if (!query) {
      resultsBox.innerHTML = "";
      return;
    }

    fetch(`/search-music/?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      resultsBox.innerHTML = "";
      const tracks = data.tracks;

      if (tracks.length === 0) {
        resultsBox.innerHTML = "<p class='text-gray-500'>No results found.</p>";
        return;
      }

      tracks.forEach(track => {
        const resultItem = document.createElement("div");
        resultItem.className = "cursor-pointer hover:bg-indigo-50 px-2 py-1 rounded-md";
        resultItem.textContent = `${track.name} - ${track.artist}`;
        resultItem.addEventListener("click", () => {
          songTitleField.value = `${track.name} - ${track.artist}`;
          songUrlField.value = track.url;
          toggleButton.innerHTML = `üéµ Sharing: ${track.name} - ${track.artist}`;
          searchBox.classList.add("hidden");
          resultsBox.innerHTML = "";
          searchInput.value = "";
        });
        resultsBox.appendChild(resultItem);
      });
    });
  });
});
</script>
{% endblock %}
